name: Build and Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: moviehub-gke-cluster
  GKE_REGION: us-central1
  REGISTRY: gcr.io

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./Back-end
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
      working-directory: ./Back-end
    
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal
      working-directory: ./Back-end

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service:
          - auth
          - user
          - movie-metadata
          - upload
          - streaming
          - library
          - torrent
          - notification
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: Configure Docker to use gcloud
      run: gcloud auth configure-docker
    
    - name: Build Docker image
      run: |
        docker build \
          -f src/Services/${{ matrix.service }}/Dockerfile \
          -t $REGISTRY/$GCP_PROJECT_ID/${{ matrix.service }}-service:${{ github.sha }} \
          -t $REGISTRY/$GCP_PROJECT_ID/${{ matrix.service }}-service:latest \
          .
      working-directory: ./Back-end
    
    - name: Push Docker image
      run: |
        docker push $REGISTRY/$GCP_PROJECT_ID/${{ matrix.service }}-service:${{ github.sha }}
        docker push $REGISTRY/$GCP_PROJECT_ID/${{ matrix.service }}-service:latest

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER \
          --region $GKE_REGION \
          --project $GCP_PROJECT_ID
    
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secrets.yaml
        kubectl apply -f k8s/services/
        kubectl apply -f k8s/istio/
      working-directory: ./Back-end
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/auth-service -n moviehub
        kubectl rollout status deployment/user-service -n moviehub
        kubectl get services -n moviehub
